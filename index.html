<!DOCTYPE html>
<html lang="id" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Hub Ultimate: Platform Analisis & Edukasi Kripto Terpadu</title>

    <!-- Meta Tags for SEO & Sharing -->
    <meta name="description" content="Crypto Hub Ultimate: Platform analisis dan edukasi kripto all-in-one dengan data real-time, AI summary, portofolio cloud, simulator trading, dan UI/UX modern.">
    <meta name="keywords" content="crypto, blockchain, bitcoin, ethereum, defi, nft, cryptocurrency, belajar kripto, harga kripto, analisis kripto, portofolio kripto, simulator trading, berita kripto AI">
    <meta name="author" content="Gemini Fusion Project">
    <meta property="og:title" content="Crypto Hub Ultimate: Platform Analisis & Edukasi Kripto Terpadu">
    <meta property="og:description" content="Jelajahi dunia kripto dengan alat analisis canggih, berita yang diringkas AI, portofolio berbasis cloud, dan fitur edukasi interaktif.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://placehold.co/1200x630/0f172a/38bdf8?text=Crypto+Hub+Ultimate">

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


    <!-- Firebase SDK -->
    <script type="module">
        // Mengimpor modul-modul yang dibutuhkan dari Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, onSnapshot, query, addDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Firebase akan diambil dari environment Canvas (__firebase_config)
        // Jika tidak ada, akan menggunakan placeholder (untuk development lokal)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY", // Ganti dengan config Anda jika testing lokal
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Menyimpan instance Firebase di window object agar bisa diakses secara global di dalam skrip modul
        window.firebase = {
            app: initializeApp(firebaseConfig),
            getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            getFirestore, doc, getDoc, setDoc, deleteDoc, collection, onSnapshot, query, addDoc, getDocs, writeBatch
        };
    </script>
    
    <!-- Tailwind CSS Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                        poppins: ['Poppins', 'sans-serif']
                    },
                    colors: {
                        // Tema warna yang bisa diganti-ganti
                        primary: 'rgba(var(--primary-rgb), <alpha-value>)',
                        'primary-dark': 'rgba(var(--primary-dark-rgb), <alpha-value>)',
                         // Warna dasar
                        cyan: { 400: '#22d3ee', 500: '#06b6d4', 600: '#0891b2' },
                        purple: { 500: '#8b5cf6', 600: '#7c3aed' },
                        green: { 500: '#22c55e', 600: '#16a34a' },
                        // Warna UI
                        'pro-dark': '#0d1117',
                        'pro-light': '#f7faff',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        shake: { '0%,100%': { transform: 'translateX(0)' }, '10%,30%,50%,70%,90%': { transform: 'translateX(-5px)' }, '20%,40%,60%,80%': { transform: 'translateX(5px)' } },
                        shimmer: { '100%': { transform: 'translateX(100%)' } },
                        pulseGlow: { '0%,100%': { boxShadow: '0 0 8px rgba(var(--primary-rgb),0.3)' }, '50%': { boxShadow: '0 0 24px rgba(var(--primary-rgb),0.6)' } },
                    },
                    animation: {
                        fadeIn: 'fadeIn 0.5s ease-out forwards',
                        shake: 'shake 0.5s ease-in-out',
                        shimmer: 'shimmer 1.5s infinite',
                        pulseGlow: 'pulseGlow 2.5s ease-in-out infinite',
                    }
                }
            }
        }
    </script>

    <!-- Custom Styles -->
    <style>
        :root {
            --primary-rgb: 6, 182, 212; /* Cyan */
            --primary-dark-rgb: 8, 145, 178;
        }
        [data-theme="purple"] { --primary-rgb: 139, 92, 246; --primary-dark-rgb: 124, 58, 237; }
        [data-theme="green"] { --primary-rgb: 34, 197, 94; --primary-dark-rgb: 22, 163, 74; }

        /* Latar belakang profesional dan futuristik */
        body {
            font-family: 'inter', sans-serif;
            background-color: #f7faff;
            color: #1e293b;
            background-image: linear-gradient(180deg, #f7faff 0%, #f0f5ff 100%);
            background-attachment: fixed;
            transition: background-color 0.5s ease;
        }
        .dark body {
            background-color: #0d1117;
            color: #cbd5e1;
            background-image: 
                radial-gradient(circle at 1px 1px, rgba(255, 255, 255, 0.07) 1px, transparent 0),
                radial-gradient(at top center, rgba(var(--primary-rgb), 0.15), transparent 40%);
            background-size: 2rem 2rem, 100% 100%;
            background-attachment: fixed;
        }

        h1, h2, h3, h4 { font-family: 'poppins', sans-serif; }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0); }
        .dark ::-webkit-scrollbar-track { background: rgba(0,0,0,0); }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #374151; }
        
        /* Glassmorphism Card Pro - Gaya utama kartu */
        .glass-card-pro {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid rgba(203, 213, 225, 0.5);
            transition: all 0.3s ease;
        }
        .dark .glass-card-pro {
            background: rgba(23, 28, 40, 0.75);
            border: 1px solid rgba(51, 65, 85, 0.5);
        }
        .glass-card-pro:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
        }

        /* Styling untuk link navigasi aktif */
        .nav-link.active {
            background: rgba(var(--primary-rgb), 0.1);
            color: rgb(var(--primary-rgb));
            font-weight: 600;
        }
        .nav-link.active svg { color: rgb(var(--primary-rgb)); }

        /* Skeleton Loader (untuk efek loading) */
        .skeleton-loader {
            position: relative; overflow: hidden; background-color: #e2e8f0; border-radius: 0.75rem;
        }
        .dark .skeleton-loader { background-color: #1e293b; }
        .skeleton-loader::after {
            content: ''; position: absolute; top: 0; left: -150%; width: 150%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 1.5s infinite;
        }
        .dark .skeleton-loader::after { background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent); }

        /* Styling Tombol & Input */
        .btn-pro {
            background-image: linear-gradient(to right, rgb(var(--primary-rgb)), rgb(var(--primary-dark-rgb)));
            transition: all 0.3s ease;
        }
        .btn-pro:hover { box-shadow: 0 0 20px rgba(var(--primary-rgb), 0.4); transform: translateY(-2px); }
        .input-pro {
            background-color: #fff; border: 1px solid #cbd5e1;
        }
        .dark .input-pro {
            background-color: #1e293b; border-color: #334155;
        }
        .input-pro:focus {
            border-color: rgb(var(--primary-rgb));
            box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.2);
            outline: none;
        }

        /* Notifikasi Toast */
        #toast-container {
            position: fixed; bottom: 1.25rem; right: 1.25rem; z-index: 9999;
        }
        .toast-item {
            opacity: 0; transform: translateX(100%); transition: all 0.5s ease;
        }
        .toast-item.show { opacity: 1; transform: translateX(0); }
        
        .price-up { color: #22c55e; }
        .price-down { color: #ef4444; }
    </style>
</head>

<body class="antialiased">

    <!-- Area Notifikasi Toast -->
    <div id="toast-container"></div>
    
    <!-- Canvas untuk Efek Confetti (dari skrip Deepseek/Grok) -->
    <canvas id="confetti-canvas" class="fixed top-0 left-0 w-full h-full pointer-events-none z-[10000]"></canvas>

    <!-- Tombol Menu Mobile -->
    <button id="mobile-menu-toggle" class="md:hidden p-2 fixed top-4 left-4 z-40 bg-white/50 dark:bg-slate-900/50 backdrop-blur-sm rounded-lg">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>
    
    <!-- Struktur Utama Aplikasi -->
    <div id="app-container" class="flex flex-col md:flex-row min-h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-72 bg-white/80 dark:bg-black/50 border-r border-slate-200/80 dark:border-slate-800/80 backdrop-blur-lg md:sticky fixed top-0 h-screen flex-col p-4 z-30 hidden md:flex -translate-x-full md:translate-x-0 transition-transform duration-300">
            <!-- Header Sidebar -->
            <div class="flex justify-between items-center mb-6 px-2">
                <div class="flex items-center gap-3">
                    <svg class="w-8 h-8 text-primary" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16.62,10.95c-1.32-1.32-3.48-1.32-4.8,0L10.3,12.47c-1.32,1.32-1.32,3.48,0,4.8c1.32,1.32,3.48,1.32,4.8,0l1.52-1.52C17.95,14.43,17.95,12.27,16.62,10.95Z" fill="currentColor"/><path d="M12.47,10.3l1.52-1.52c-1.32-1.32-1.32-3.48,0-4.8c-1.32-1.32-3.48-1.32-4.8,0L7.67,5.5c-1.32,1.32-1.32,3.48,0,4.8L12.47,10.3Z" fill="currentColor" fill-opacity="0.4"/></svg>
                    <h1 class="text-xl font-extrabold">Crypto Hub <span class="text-xs font-medium text-primary">Ultimate</span></h1>
                </div>
            </div>
            
            <!-- Navigasi -->
            <nav id="navigation" class="flex-grow">
                <ul class="space-y-1"></ul>
            </nav>
            
            <!-- User/Footer Section -->
            <div class="mt-auto pt-4 border-t border-slate-200 dark:border-slate-800">
                <div id="user-info" class="text-xs text-slate-500 mb-4 px-2">
                    <p>User ID (dari Firebase):</p>
                    <p id="user-id-display" class="break-all font-mono">Loading...</p>
                </div>
                 <div class="flex justify-around items-center gap-4">
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors">
                        <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                        <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                    </button>
                    <div class="flex gap-2 justify-center" role="radiogroup" aria-label="Pilih tema warna">
                        <button data-theme="cyan" aria-label="Tema Sian" class="w-5 h-5 rounded-full bg-cyan-500 ring-2 ring-offset-2 ring-transparent ring-offset-white dark:ring-offset-pro-dark"></button>
                        <button data-theme="purple" aria-label="Tema Ungu" class="w-5 h-5 rounded-full bg-purple-500 ring-2 ring-offset-2 ring-transparent ring-offset-white dark:ring-offset-pro-dark"></button>
                        <button data-theme="green" aria-label="Tema Hijau" class="w-5 h-5 rounded-full bg-green-500 ring-2 ring-offset-2 ring-transparent ring-offset-white dark:ring-offset-pro-dark"></button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Konten Utama -->
        <main class="main-content flex-1 md:ml-72 p-4 sm:p-6 lg:p-8 overflow-y-auto">
            <div id="page-header" class="flex justify-between items-center mb-6">
                 <h2 id="page-title" class="text-3xl font-extrabold text-slate-900 dark:text-white"></h2>
            </div>
            <div id="page-content" class="animate-fadeIn"></div>
        </main>
    </div>

    <!-- Modal Universal -->
    <div id="modal-container" class="hidden fixed inset-0 z-[9998] flex items-center justify-center p-4">
        <div id="modal-backdrop" class="fixed inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div id="modal-content-box" class="relative z-10 bg-white/80 dark:bg-slate-900/80 p-6 rounded-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto glass-card-pro animate-fadeIn">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold"></h3>
                <button id="modal-close" class="text-slate-500 hover:text-primary"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <!-- === JAVASCRIPT LOGIC === -->
    <script type="module">
        // --- GLOBAL STATE & CONFIG ---
        const state = {
            currentPage: 'dasbor',
            firebase: window.firebase,
            db: null,
            auth: null,
            userId: null,
            isAuthReady: false,
            activeCharts: {},
            portfolioListener: null, // Untuk unsubscribe dari listener Firestore
        };

        const config = {
            appId: typeof __app_id !== 'undefined' ? __app_id : 'crypto-hub-ultimate',
            api: {
                coingecko: 'https://api.coingecko.com/api/v3',
                fearAndGreed: 'https://api.alternative.me/fng/?limit=1',
                rss2json: 'https://api.rss2json.com/v1/api.json?rss_url=',
                newsSources: [
                    { name: 'CoinTelegraph', url: 'https://cointelegraph.com/rss' },
                    { name: 'CoinDesk', url: 'https://www.coindesk.com/arc/outboundfeeds/rss/' },
                    { name: 'Decrypt', url: 'https://decrypt.co/feed' }
                ],
            },
            gemini: {
                 apiUrl: (apiKey) => `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
                 apiKey: "" // Disediakan oleh environment Canvas, biarkan kosong
            }
        };
        
        // Data untuk Kamus Kripto yang telah diperbarui
        const kamusContent = [
            {
                category: 'Konsep Dasar',
                icon: 'fa-solid fa-cubes',
                items: [
                    { term: 'Blockchain', definition: 'Buku besar digital terdesentralisasi yang mencatat semua transaksi secara permanen dan transparan dalam "rantai blok". Ini adalah teknologi inti di balik sebagian besar aset kripto.' },
                    { term: 'Cryptocurrency', definition: 'Aset digital yang menggunakan kriptografi untuk mengamankan transaksi, mengontrol pembuatan unit baru, dan memverifikasi transfer aset.' },
                    { term: 'Desentralisasi', definition: 'Distribusi kekuasaan dan kontrol dari satu entitas pusat ke banyak titik dalam jaringan. Tidak ada satu pihak pun yang memiliki kendali penuh.' },
                    { term: 'Wallet (Dompet)', definition: 'Program perangkat lunak atau perangkat keras yang menyimpan kunci publik dan pribadi Anda. Kunci ini digunakan untuk mengirim dan menerima aset kripto. Ada <strong>Hot Wallet</strong> (online) dan <strong>Cold Wallet</strong> (offline).' },
                ]
            },
            {
                category: 'Dunia DeFi & NFT',
                icon: 'fa-solid fa-hand-holding-dollar',
                items: [
                    { term: 'DeFi (Decentralized Finance)', definition: 'Ekosistem aplikasi keuangan yang dibangun di atas blockchain, memungkinkan layanan seperti pinjam-meminjam dan trading tanpa perantara seperti bank.' },
                    { term: 'NFT (Non-Fungible Token)', definition: 'Token unik yang mewakili kepemilikan atas aset digital atau fisik, seperti seni, musik, atau item dalam game. Tidak dapat ditukar satu sama lain.' },
                    { term: 'Smart Contract', definition: 'Program yang berjalan di blockchain dan dieksekusi secara otomatis ketika kondisi tertentu terpenuhi. Ini adalah tulang punggung dari DeFi dan NFT.' },
                    { term: 'Yield Farming', definition: 'Strategi untuk memaksimalkan keuntungan dengan cara meminjamkan atau men-stake aset kripto di berbagai protokol DeFi untuk mendapatkan imbalan.' },
                ]
            },
            {
                category: 'Trading & Investasi',
                icon: 'fa-solid fa-chart-line',
                items: [
                    { term: 'HODL', definition: 'Singkatan dari "Hold On for Dear Life". Ini adalah strategi investasi jangka panjang di mana investor menahan aset kripto mereka terlepas dari fluktuasi harga.' },
                    { term: 'ATH (All-Time High)', definition: 'Harga tertinggi yang pernah dicapai oleh suatu aset kripto sepanjang sejarahnya.' },
                    { term: 'FOMO (Fear Of Missing Out)', definition: 'Perasaan cemas atau takut ketinggalan keuntungan besar, yang seringkali mendorong keputusan investasi yang impulsif saat pasar sedang naik.' },
                    { term: 'Whale (Paus)', definition: 'Individu atau entitas yang memegang sejumlah besar aset kripto, yang tindakannya dapat mempengaruhi pasar secara signifikan.' },
                ]
            },
            {
                category: 'Teknologi & Keamanan',
                icon: 'fa-solid fa-shield-halved',
                items: [
                    { term: 'Private Key (Kunci Pribadi)', definition: 'Kode rahasia yang memberikan akses penuh ke aset kripto Anda di dalam dompet. Siapa pun yang memiliki kunci ini dapat mengontrol dana Anda. Jaga kerahasiaannya!' },
                    { term: 'Seed Phrase (Frasa Pemulihan)', definition: 'Daftar 12 hingga 24 kata yang dapat digunakan untuk memulihkan akses ke dompet kripto Anda jika Anda kehilangan perangkat. Ini adalah master key Anda.' },
                    { term: 'Layer 2 (L2)', definition: 'Sebuah kerangka kerja atau protokol sekunder yang dibangun di atas blockchain utama (Layer 1) untuk meningkatkan kecepatan transaksi dan mengurangi biaya. Contoh: Arbitrum, Optimism.' },
                    { term: 'Gas Fee', definition: 'Biaya yang dibayarkan kepada validator jaringan untuk memproses transaksi di blockchain, terutama di jaringan Ethereum. Biayanya bervariasi tergantung pada kepadatan jaringan.' },
                ]
            },
        ];

        // Struktur menu navigasi utama
        const appData = [
            { id: 'dasbor', title: 'Dasbor', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>`, render: renderDashboard },
            { id: 'portofolio', title: 'Portofolio', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20V16"/></svg>`, render: renderPortfolio },
            { id: 'berita', title: 'Berita & AI Summary', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h16"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M12 10h4"/></svg>`, render: renderNews },
            { type: 'divider', title: 'Edukasi & Simulasi' },
            { id: 'kamus', title: 'Kamus Kripto', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>`, render: renderDictionary },
            { id: 'simulator', title: 'Simulator Trading', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 14 4-4"/><path d="M3.34 19a10 10 0 1 1 17.32 0"/></svg>`, render: renderSimulator },
            { type: 'divider', title: 'Alat' },
            { id: 'alat', title: 'Alat Bantu', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.7 18.9c.4-1.5.7-3.2.7-5s-.3-3.5-.7-5"/><path d="M12 17.8c-1.8 0-3.5-.4-5-1.1"/><path d="M2.3 18.9c-.4-1.5-.7-3.2-.7-5s.3-3.5.7-5"/><path d="M12 6.2c1.8 0 3.5.4 5 1.1"/><path d="m3 7 18 10"/><path d="m21 7-18 10"/></svg>`, render: renderTools },
        ];
        
        // --- UTILITY FUNCTIONS ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        
        const debounce = (func, wait) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        };

        const showToast = (message, type = 'success', duration = 3000) => {
            const container = $('#toast-container');
            const toastId = `toast-${Date.now()}`;
            const colors = {
                success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500'
            };
            const toastHTML = `
                <div id="${toastId}" class="toast-item flex items-center w-full max-w-xs p-4 mb-4 text-white ${colors[type]} rounded-lg shadow-lg">
                    <div class="ms-3 text-sm font-normal">${message}</div>
                </div>`;
            container.insertAdjacentHTML('beforeend', toastHTML);
            const toastElement = $(`#${toastId}`);
            
            setTimeout(() => {
                toastElement.classList.add('show');
                setTimeout(() => {
                    toastElement.classList.remove('show');
                    toastElement.addEventListener('transitionend', () => toastElement.remove());
                }, duration);
            }, 10);
        };

        const openModal = (title, content) => {
            $('#modal-title').innerHTML = title;
            $('#modal-body').innerHTML = content;
            $('#modal-container').classList.remove('hidden');
        };

        const closeModal = () => {
            $('#modal-container').classList.add('hidden');
            $('#modal-title').innerHTML = '';
            $('#modal-body').innerHTML = '';
        };
        
        const triggerConfetti = () => {
            const canvas = $('#confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const particles = [];
            const colors = ['#06b6d4', '#8b5cf6', '#22c55e', '#f97316', '#ec4899'];
            
            for (let i = 0; i < 150; i++) {
                particles.push({
                    x: Math.random() * canvas.width, y: -20,
                    size: Math.random() * 10 + 5,
                    speed: Math.random() * 3 + 2,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    angle: Math.random() * 360,
                    rotation: Math.random() * 10
                });
            }
            
            let animationFrame;
            function animateConfetti() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach((p, index) => {
                    p.y += p.speed;
                    p.x += Math.sin(p.angle * Math.PI / 180) * 2;
                    p.angle += 2;
                    
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rotation * Math.PI / 180);
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                    ctx.restore();
                    p.rotation += 5;

                    if (p.y > canvas.height) {
                        particles.splice(index, 1);
                    }
                });
                
                if (particles.length > 0) {
                    animationFrame = requestAnimationFrame(animateConfetti);
                } else {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    cancelAnimationFrame(animationFrame);
                }
            }
            animateConfetti();
        };

        // --- API & DATA FETCHING ---
        const apiFetch = async (url, cacheKey, cacheDurationMinutes = 5) => {
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                try {
                    const { data, timestamp } = JSON.parse(cached);
                    if (Date.now() - timestamp < cacheDurationMinutes * 60 * 1000) return data;
                } catch(e) { console.error("Gagal mem-parsing cache", e); }
            }
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                localStorage.setItem(cacheKey, JSON.stringify({ data, timestamp: Date.now() }));
                return data;
            } catch (error) {
                console.error(`Gagal mengambil data dari ${url}:`, error);
                if(cached) return JSON.parse(cached).data;
                return null;
            }
        };

        const getAiSummary = async (text) => {
            const prompt = `Ringkas artikel berita berikut dalam 3-4 poin utama menggunakan bahasa Indonesia yang santai dan mudah dimengerti. Fokus pada informasi paling penting yang relevan untuk investor atau peminat kripto. Berikut artikelnya:\n\n---\n\n${text}`;
             try {
                 let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                 const payload = { contents: chatHistory };
                 const apiUrl = config.gemini.apiUrl(config.gemini.apiKey);
                 const response = await fetch(apiUrl, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(payload)
                 });

                 if (!response.ok) {
                     const errorBody = await response.text();
                     console.error("Gemini API Error:", response.status, errorBody);
                     throw new Error(`AI Gagal merangkum, status: ${response.status}`);
                 }

                 const result = await response.json();
                 
                 if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                     return result.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
                 } else {
                     console.error("Struktur respons API Gemini tidak terduga:", result);
                     throw new Error("Format respons AI tidak valid.");
                 }
             } catch (error) {
                 console.error("Gagal fetch ke Gemini:", error);
                 return `<p class="text-red-500">Maaf, AI sedang istirahat. Gagal merangkum berita. ${error.message}</p>`;
             }
        };

        // --- FIREBASE & AUTHENTICATION ---
        const initAuth = async () => {
            state.auth = state.firebase.getAuth(state.firebase.app);
            state.db = state.firebase.getFirestore(state.firebase.app);

            return new Promise((resolve) => {
                state.firebase.onAuthStateChanged(state.auth, async (user) => {
                    if (user) {
                        state.userId = user.uid;
                        $('#user-id-display').textContent = state.userId;
                        state.isAuthReady = true;
                        resolve(user);
                    } else {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await state.firebase.signInWithCustomToken(state.auth, __initial_auth_token);
                            } else {
                                await state.firebase.signInAnonymously(state.auth);
                            }
                        } catch (error) {
                            console.error("Gagal login anonim:", error);
                            state.userId = 'offline-' + Date.now();
                            $('#user-id-display').textContent = 'Offline Mode';
                            state.isAuthReady = true;
                            resolve(null);
                        }
                    }
                });
            });
        };

        // --- CHARTING FUNCTIONS ---
        const destroyChart = (chartId) => {
            if (state.activeCharts[chartId]) {
                state.activeCharts[chartId].destroy();
                delete state.activeCharts[chartId];
            }
        };
        
        // --- PAGE RENDER FUNCTIONS ---
        
        async function renderDashboard() {
            const contentEl = $('#page-content');
            contentEl.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-6 gap-6">
                    <div class="lg:col-span-4 space-y-6">
                         <div class="glass-card-pro p-4 md:p-6 rounded-2xl">
                            <h3 class="text-xl font-bold mb-4">Live Market</h3>
                            <div id="price-table-container" class="overflow-x-auto"></div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 space-y-6">
                        <div id="fear-greed-widget" class="glass-card-pro p-6 rounded-2xl flex flex-col justify-center items-center h-48"></div>
                        <div id="watchlist-widget" class="glass-card-pro p-6 rounded-2xl h-48"></div>
                    </div>
                </div>`;
            
            renderPriceTable();
            renderFearGreed();
            $('#watchlist-widget').innerHTML = `<h3 class="text-xl font-bold mb-4">Watchlist</h3><p class="text-slate-500 text-sm">Fitur watchlist akan segera hadir untuk memantau koin favoritmu!</p>`;
        }
        
        async function renderPriceTable() {
            const container = $('#price-table-container');
            container.innerHTML = `<div class="w-full h-96 skeleton-loader"></div>`;
            const coins = await apiFetch(`${config.api.coingecko}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=20&page=1&sparkline=false`, 'market_data', 2);
            if (!coins) {
                container.innerHTML = `<p class="text-red-500">Gagal memuat data pasar.</p>`;
                return;
            }
            container.innerHTML = `
                <table class="w-full text-left text-sm">
                    <thead>
                        <tr class="border-b border-slate-200 dark:border-slate-800">
                            <th class="p-2">#</th>
                            <th class="p-2">Coin</th>
                            <th class="p-2 text-right">Price</th>
                            <th class="p-2 text-right">24h %</th>
                            <th class="p-2 text-right hidden md:table-cell">Market Cap</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${coins.map(coin => `
                            <tr class="hover:bg-slate-100/50 dark:hover:bg-slate-800/50 cursor-pointer" data-coin-id="${coin.id}">
                                <td class="p-2">${coin.market_cap_rank}</td>
                                <td class="p-2 flex items-center gap-3">
                                    <img src="${coin.image}" class="w-6 h-6 rounded-full" alt="${coin.name}" loading="lazy" onerror="this.src='https://placehold.co/32x32/1e293b/ffffff?text=${coin.symbol.charAt(0).toUpperCase()}'">
                                    <div>
                                        <div class="font-semibold">${coin.name}</div>
                                        <div class="text-xs text-slate-500">${coin.symbol.toUpperCase()}</div>
                                    </div>
                                </td>
                                <td class="p-2 text-right font-semibold">$${coin.current_price.toLocaleString('en-US')}</td>
                                <td class="p-2 text-right font-semibold ${coin.price_change_percentage_24h >= 0 ? 'price-up' : 'price-down'}">
                                    ${coin.price_change_percentage_24h ? coin.price_change_percentage_24h.toFixed(2) : 'N/A'}%
                                </td>
                                <td class="p-2 text-right hidden md:table-cell">$${coin.market_cap.toLocaleString('en-US')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
            $$('#price-table-container tr[data-coin-id]').forEach(row => {
                row.addEventListener('click', () => showCoinDetails(row.dataset.coinId));
            });
        }
        
        async function renderFearGreed() {
            const container = $('#fear-greed-widget');
            container.innerHTML = `<div class="w-full h-full skeleton-loader"></div>`;
            const fngData = await apiFetch(config.api.fearAndGreed, 'fng_data', 60);
            if (!fngData || !fngData.data[0]) {
                container.innerHTML = `<p class="text-red-500">Gagal memuat F&G Index.</p>`; return;
            }
            const { value, value_classification } = fngData.data[0];
            const color = value > 50 ? 'text-green-500' : 'text-red-500';
            container.innerHTML = `
                <h3 class="text-xl font-bold mb-2">Fear & Greed Index</h3>
                <p class="text-6xl font-extrabold ${color}">${value}</p>
                <p class="text-xl font-semibold ${color}">${value_classification}</p>
                <p class="text-xs text-slate-500 mt-2">Data dari alternative.me</p>`;
        }
        
        async function showCoinDetails(coinId) {
            openModal('Loading Details...', `<div class="h-96 skeleton-loader"></div>`);
            const coin = await apiFetch(`${config.api.coingecko}/coins/${coinId}?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=false`, `coin_${coinId}`, 5);
            if(!coin) {
                openModal('Error', `<p class="text-red-500">Gagal memuat detail koin.</p>`); return;
            }
            const chartData = await apiFetch(`${config.api.coingecko}/coins/${coinId}/market_chart?vs_currency=usd&days=7`, `chart_${coinId}`, 30);
            
            const title = `
                <div class="flex items-center gap-3">
                    <img src="${coin.image.small}" class="w-8 h-8 rounded-full" alt="${coin.name}">
                    <span>${coin.name} <span class="text-slate-500">${coin.symbol.toUpperCase()}</span></span>
                </div>`;
                
            let content = `
                <div class="h-48 mb-4"><canvas id="coin-detail-chart"></canvas></div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                    <div class="glass-card-pro p-3 rounded-lg">
                        <p class="text-xs text-slate-500">Harga</p>
                        <p class="font-semibold text-lg">$${coin.market_data.current_price.usd.toLocaleString('en-US')}</p>
                    </div>
                    <div class="glass-card-pro p-3 rounded-lg">
                        <p class="text-xs text-slate-500">Market Cap</p>
                        <p class="font-semibold text-lg">$${coin.market_data.market_cap.usd.toLocaleString('en-US')}</p>
                    </div>
                    <div class="glass-card-pro p-3 rounded-lg">
                        <p class="text-xs text-slate-500">24h Volume</p>
                        <p class="font-semibold text-lg">$${coin.market_data.total_volume.usd.toLocaleString('en-US')}</p>
                    </div>
                    <div class="glass-card-pro p-3 rounded-lg">
                        <p class="text-xs text-slate-500">24h Change</p>
                        <p class="font-semibold text-lg ${coin.market_data.price_change_percentage_24h >= 0 ? 'price-up' : 'price-down'}">${coin.market_data.price_change_percentage_24h.toFixed(2)}%</p>
                    </div>
                    <div class="glass-card-pro p-3 rounded-lg">
                        <p class="text-xs text-slate-500">Circulating Supply</p>
                        <p class="font-semibold text-lg">${coin.market_data.circulating_supply.toLocaleString('en-US')}</p>
                    </div>
                    <div class="glass-card-pro p-3 rounded-lg">
                        <p class="text-xs text-slate-500">All-Time High</p>
                        <p class="font-semibold text-lg">$${coin.market_data.ath.usd.toLocaleString('en-US')}</p>
                    </div>
                </div>
                <div class="mt-4">
                    <h4 class="font-bold mb-2">Tentang ${coin.name}</h4>
                    <p class="text-sm text-slate-400 line-clamp-4">${coin.description.en || 'Tidak ada deskripsi.'}</p>
                </div>`;
            
            openModal(title, content);

            if(chartData?.prices) {
                const labels = chartData.prices.map(p => p[0]);
                const data = chartData.prices.map(p => p[1]);
                const borderColor = data[0] <= data[data.length - 1] ? 'rgba(34, 197, 94, 1)' : 'rgba(239, 68, 68, 1)';
                const bgColor = data[0] <= data[data.length - 1] ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)';
                
                destroyChart('coin-detail-chart');
                const ctx = document.getElementById('coin-detail-chart')?.getContext('2d');
                if(ctx) {
                    state.activeCharts['coin-detail-chart'] = new Chart(ctx, {
                        type: 'line', data: { labels: labels, datasets: [{ label: 'Harga (USD)', data: data, borderColor: borderColor, backgroundColor: bgColor, borderWidth: 2, pointRadius: 0, fill: true }] },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: {
                                x: { type: 'time', time: { unit: 'day' }, ticks: { color: '#94a3b8' } },
                                y: { ticks: { callback: value => '$' + value.toLocaleString(), color: '#94a3b8' } }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                }
            }
        }
        
        // --- PORTFOLIO FUNCTIONS (Cloud-based with Firebase) ---
        function renderPortfolio() {
            const contentEl = $('#page-content');
            if(!state.isAuthReady) {
                contentEl.innerHTML = `<div class="text-center p-8 glass-card-pro rounded-2xl"><p>Menghubungkan ke Firebase...</p></div>`; return;
            }
            contentEl.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div id="portfolio-summary-card" class="glass-card-pro p-6 rounded-2xl"></div>
                        <div id="portfolio-list-card" class="glass-card-pro p-6 rounded-2xl">
                             <h3 class="text-xl font-bold mb-4">Aset Saya</h3>
                             <div id="portfolio-list" class="space-y-4"></div>
                        </div>
                    </div>
                    <div class="space-y-6">
                         <div id="add-asset-card" class="glass-card-pro p-6 rounded-2xl">
                            <h3 class="text-xl font-bold mb-4">Tambah Aset</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="asset-name" class="text-sm font-medium">Nama Aset (e.g., Bitcoin)</label>
                                    <input type="text" id="asset-name" class="mt-1 block w-full p-2 input-pro rounded-md" >
                                </div>
                                <div>
                                    <label for="asset-amount" class="text-sm font-medium">Jumlah</label>
                                    <input type="number" id="asset-amount" class="mt-1 block w-full p-2 input-pro rounded-md" min="0">
                                </div>
                                <div>
                                    <label for="asset-buy-price" class="text-sm font-medium">Harga Beli per Koin ($)</label>
                                    <input type="number" id="asset-buy-price" class="mt-1 block w-full p-2 input-pro rounded-md" min="0">
                                </div>
                                <button id="add-asset-btn" class="w-full btn-pro text-white font-semibold py-2 rounded-lg">Tambah Aset</button>
                            </div>
                        </div>
                        <button id="clear-portfolio-btn" class="w-full bg-red-500/20 text-red-500 font-semibold py-2 rounded-lg hover:bg-red-600 hover:text-white transition-colors">Kosongkan Portofolio</button>
                    </div>
                </div>`;
            
            listenToPortfolio();
            $('#add-asset-btn').addEventListener('click', handleAddAsset);
            $('#clear-portfolio-btn').addEventListener('click', handleClearPortfolio);
        }

        function listenToPortfolio() {
            if (state.portfolioListener) state.portfolioListener(); 
            
            const portfolioPath = `artifacts/${config.appId}/users/${state.userId}/portfolio`;
            const q = state.firebase.query(state.firebase.collection(state.db, portfolioPath));
            
            $('#portfolio-list').innerHTML = `<div class="h-40 skeleton-loader"></div>`;

            state.portfolioListener = state.firebase.onSnapshot(q, async (querySnapshot) => {
                const portfolio = [];
                querySnapshot.forEach((doc) => {
                    portfolio.push({ firestoreId: doc.id, ...doc.data() });
                });
                await updatePortfolioView(portfolio);
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                $('#portfolio-list').innerHTML = `<p class="text-red-500">Gagal memuat portofolio. Coba refresh.</p>`;
            });
        }

        async function updatePortfolioView(portfolio) {
            const listEl = $('#portfolio-list');
            const summaryEl = $('#portfolio-summary-card');

            if (!listEl || !summaryEl) return;
            
            if (portfolio.length === 0) {
                summaryEl.innerHTML = `<p class="text-center text-slate-500">Portofolio kosong.</p>`;
                listEl.innerHTML = `<p class="text-center text-slate-500">Mulai dengan menambahkan aset baru.</p>`;
                return;
            }

            const assetIds = portfolio.map(asset => asset.id).join(',');
            const prices = await apiFetch(`${config.api.coingecko}/simple/price?ids=${assetIds}&vs_currencies=usd`, `portfolio_prices_${assetIds}`, 2);
            
            let totalInvested = 0, currentValue = 0;

            listEl.innerHTML = portfolio.map(asset => {
                const currentPrice = prices?.[asset.id]?.usd || 0;
                const assetValue = asset.amount * currentPrice;
                const investedValue = asset.amount * asset.buyPrice;
                const pnl = assetValue - investedValue;
                const pnlPercent = investedValue > 0 ? (pnl / investedValue) * 100 : 0;
                const pnlClass = pnl >= 0 ? 'price-up' : 'price-down';

                totalInvested += investedValue;
                currentValue += assetValue;

                return `
                    <div class="border-b border-slate-200 dark:border-slate-800 pb-3 last:border-b-0">
                        <div class="flex justify-between items-center">
                            <h4 class="font-bold">${asset.name} (${asset.symbol.toUpperCase()})</h4>
                            <button class="remove-asset-btn text-slate-400 hover:text-red-500" data-firestore-id="${asset.firestoreId}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </div>
                        <div class="flex justify-between text-sm mt-1">
                            <span>Jumlah: ${asset.amount.toLocaleString('en-US', {maximumFractionDigits: 6})}</span>
                            <span class="font-semibold">$${assetValue.toLocaleString('en-US', {maximumFractionDigits: 2})}</span>
                        </div>
                        <div class="flex justify-between text-xs text-slate-500">
                            <span>Avg. Buy: $${asset.buyPrice.toLocaleString('en-US', {maximumFractionDigits: 2})}</span>
                            <span class="${pnlClass}">${pnl >= 0 ? '+' : ''}$${pnl.toLocaleString('en-US', {maximumFractionDigits: 2})} (${pnlPercent.toFixed(2)}%)</span>
                        </div>
                    </div>`;
            }).join('');
            
            $$('.remove-asset-btn').forEach(btn => btn.addEventListener('click', () => handleRemoveAsset(btn.dataset.firestoreId)));

            const totalPnl = currentValue - totalInvested;
            const totalPnlPercent = totalInvested > 0 ? (totalPnl / totalInvested) * 100 : 0;
            const totalPnlClass = totalPnl >= 0 ? 'price-up' : 'price-down';

            summaryEl.innerHTML = `
                <p class="text-sm text-slate-400">Nilai Portofolio</p>
                <p class="text-4xl font-extrabold">$${currentValue.toLocaleString('en-US', {maximumFractionDigits: 2})}</p>
                <p class="font-semibold ${totalPnlClass} mt-1">${totalPnl >= 0 ? '+' : ''}$${totalPnl.toLocaleString('en-US', {maximumFractionDigits: 2})} (${totalPnlPercent.toFixed(2)}%)</p>
                <div class="text-xs text-slate-500 mt-2">Modal: $${totalInvested.toLocaleString('en-US', {maximumFractionDigits: 2})}</div>`;
        }
        
        async function handleAddAsset() {
            const name = $('#asset-name').value.trim();
            const amount = parseFloat($('#asset-amount').value);
            const buyPrice = parseFloat($('#asset-buy-price').value);

            if (!name || isNaN(amount) || amount <= 0 || isNaN(buyPrice) || buyPrice < 0) {
                showToast('Harap isi semua kolom dengan valid!', 'error'); return;
            }

            showToast('Mencari aset...', 'info');
            const searchData = await apiFetch(`${config.api.coingecko}/search?query=${name}`, `search_${name}`, 1440);
            if (!searchData?.coins?.length) {
                showToast(`Aset "${name}" tidak ditemukan.`, 'error'); return;
            }
            
            const coin = searchData.coins[0];
            const assetData = {
                id: coin.id, name: coin.name, symbol: coin.symbol, amount: amount, buyPrice: buyPrice,
            };

            try {
                const portfolioPath = `artifacts/${config.appId}/users/${state.userId}/portfolio`;
                await state.firebase.addDoc(state.firebase.collection(state.db, portfolioPath), assetData);
                showToast(`${coin.name} berhasil ditambahkan!`, 'success');
                $('#asset-name').value = ''; $('#asset-amount').value = ''; $('#asset-buy-price').value = '';
            } catch (error) {
                console.error("Error adding asset to Firestore:", error); showToast('Gagal menyimpan aset.', 'error');
            }
        }
        
        async function handleRemoveAsset(firestoreId) {
             try {
                const docPath = `artifacts/${config.appId}/users/${state.userId}/portfolio/${firestoreId}`;
                await state.firebase.deleteDoc(state.firebase.doc(state.db, docPath));
                showToast('Aset berhasil dihapus.', 'success');
             } catch(error) {
                console.error("Error removing asset:", error); showToast('Gagal menghapus aset.', 'error');
             }
        }
        
        async function handleClearPortfolio() {
            openModal('Konfirmasi', `
                <p>Yakin mau mengosongkan seluruh portofolio? Aksi ini tidak bisa dibatalkan.</p>
                <div class="flex justify-end gap-4 mt-4">
                    <button id="confirm-clear" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">Ya, Hapus Semua</button>
                    <button id="cancel-clear" class="bg-slate-200 dark:bg-slate-700 font-semibold py-2 px-4 rounded-lg">Batal</button>
                </div>`);
            $('#cancel-clear').addEventListener('click', closeModal);
            $('#confirm-clear').addEventListener('click', async () => {
                closeModal(); showToast('Menghapus portofolio...', 'info');
                try {
                    const portfolioPath = `artifacts/${config.appId}/users/${state.userId}/portfolio`;
                    const q = state.firebase.query(state.firebase.collection(state.db, portfolioPath));
                    const snapshot = await state.firebase.getDocs(q);
                    const batch = state.firebase.writeBatch(state.db);
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    showToast('Portofolio berhasil dikosongkan.', 'success');
                } catch(error) {
                    console.error("Error clearing portfolio:", error); showToast('Gagal mengosongkan portofolio.', 'error');
                }
            });
        }
        
        // --- NEWS & AI SUMMARY FUNCTIONS ---
        async function renderNews() {
            const contentEl = $('#page-content');
            contentEl.innerHTML = `
                <div class="mb-6 flex flex-col sm:flex-row gap-4 justify-between items-center">
                    <select id="news-source-select" class="w-full sm:w-auto input-pro p-2 rounded-lg"></select>
                    <button id="refresh-news-btn" class="w-full sm:w-auto btn-pro text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4l5 5M20 20l-5-5"></path></svg>
                         <span>Refresh</span>
                    </button>
                </div>
                <div id="news-list" class="space-y-6"></div>
            `;
            const sourceSelect = $('#news-source-select');
            sourceSelect.innerHTML = config.api.newsSources.map(s => `<option value="${s.url}">${s.name}</option>`).join('');

            const fetchAndRender = async () => {
                const listEl = $('#news-list');
                listEl.innerHTML = Array(5).fill('<div class="h-40 skeleton-loader"></div>').join('');
                const sourceUrl = sourceSelect.value;
                const newsData = await apiFetch(`${config.api.rss2json}${encodeURIComponent(sourceUrl)}`, `news_${sourceUrl}`, 15);
                
                if(!newsData || newsData.status !== 'ok') {
                    listEl.innerHTML = `<div class="glass-card-pro p-6 rounded-2xl text-red-500">Gagal memuat berita dari sumber ini.</div>`;
                    return;
                }

                listEl.innerHTML = newsData.items.slice(0, 10).map((item, index) => `
                    <div class="glass-card-pro p-4 md:p-6 rounded-2xl">
                        <a href="${item.link}" target="_blank" class="text-lg font-bold hover:text-primary transition-colors">${item.title}</a>
                        <p class="text-xs text-slate-500 my-2">Oleh ${item.author} pada ${new Date(item.pubDate).toLocaleDateString()}</p>
                        <p class="text-sm line-clamp-3">${item.description.replace(/<[^>]+>/g, '')}</p>
                        <div class="mt-4 flex gap-4">
                            <button class="summarize-btn btn-pro text-white text-sm font-semibold py-2 px-4 rounded-lg flex items-center gap-2" data-index="${index}">
                                <i class="fas fa-robot"></i> Ringkas dengan AI
                            </button>
                             <a href="${item.link}" target="_blank" class="bg-slate-200 dark:bg-slate-700 text-sm font-semibold py-2 px-4 rounded-lg flex items-center gap-2">Baca Selengkapnya</a>
                        </div>
                        <div class="summary-container mt-4 p-4 bg-slate-100 dark:bg-slate-800/50 rounded-lg hidden"></div>
                    </div>
                `).join('');

                $$('.summarize-btn').forEach(btn => btn.addEventListener('click', async e => {
                    const button = e.currentTarget;
                    const index = button.dataset.index;
                    const item = newsData.items[index];
                    const summaryContainer = button.closest('.glass-card-pro').querySelector('.summary-container');
                    
                    summaryContainer.classList.remove('hidden');
                    summaryContainer.innerHTML = `<div class="flex items-center gap-2 text-sm text-slate-500"><div class="w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin"></div><span>AI sedang berpikir...</span></div>`;
                    
                    const summary = await getAiSummary(item.description.replace(/<[^>]+>/g, ''));
                    summaryContainer.innerHTML = `<h4 class="font-bold mb-2">Ringkasan AI:</h4><div class="text-sm">${summary}</div>`;
                }));
            }

            sourceSelect.addEventListener('change', fetchAndRender);
            $('#refresh-news-btn').addEventListener('click', fetchAndRender);
            fetchAndRender();
        }

        // --- DICTIONARY FEATURE (RENOVATED) ---
        function renderDictionary() {
            const contentEl = $('#page-content');
            contentEl.innerHTML = `
                <div class="mb-6 relative">
                    <input type="text" id="dictionary-search" class="w-full p-3 pl-10 input-pro rounded-lg" placeholder="Cari istilah (misal: DeFi, HODL)...">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                </div>
                <div id="dictionary-content" class="space-y-8"></div>`;
            
            const contentContainer = $('#dictionary-content');
            const searchInput = $('#dictionary-search');

            const renderContent = (filter = '') => {
                contentContainer.innerHTML = '';
                const lowerFilter = filter.toLowerCase();
                
                kamusContent.forEach(category => {
                    const filteredItems = category.items.filter(item => 
                        item.term.toLowerCase().includes(lowerFilter) || 
                        item.definition.toLowerCase().includes(lowerFilter)
                    );

                    if (filteredItems.length > 0) {
                        const categoryHtml = `
                            <div class="category-section">
                                <h3 class="text-2xl font-bold mb-4 flex items-center gap-3 text-primary">
                                    <i class="${category.icon}"></i>
                                    ${category.category}
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    ${filteredItems.map(item => `
                                        <div class="glass-card-pro p-5 rounded-xl">
                                            <h4 class="text-lg font-semibold text-slate-800 dark:text-white">${item.term}</h4>
                                            <p class="text-sm text-slate-600 dark:text-slate-300 mt-2">${item.definition}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                        contentContainer.innerHTML += categoryHtml;
                    }
                });

                if (contentContainer.innerHTML === '') {
                    contentContainer.innerHTML = `<div class="glass-card-pro p-8 rounded-2xl text-center"><p class="text-slate-500">Istilah "${filter}" tidak ditemukan.</p></div>`;
                }
            };
            
            searchInput.addEventListener('input', debounce((e) => renderContent(e.target.value), 300));
            
            renderContent(); // Render awal
        }

        // --- OTHER PAGE STUBS ---
        function renderTools() { $('#page-content').innerHTML = `<div class="glass-card-pro p-8 rounded-2xl text-center"><h3 class="text-xl font-bold">Segera Hadir</h3><p class="text-slate-400 mt-2">Fitur Alat Bantu sedang dalam pengembangan.</p></div>`; }
        function renderSimulator() { $('#page-content').innerHTML = `<div class="glass-card-pro p-8 rounded-2xl text-center"><h3 class="text-xl font-bold">Segera Hadir</h3><p class="text-slate-400 mt-2">Fitur Simulator Trading sedang dalam pengembangan. Bersiaplah untuk trading tanpa risiko!</p></div>`; }
        
        // --- INITIALIZATION ---
        async function main() {
            // Setup UI (Theme, Navigasi, Event Listeners)
            const storedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.classList.toggle('dark', storedTheme === 'dark');
            $('#theme-toggle-dark-icon').classList.toggle('hidden', storedTheme !== 'dark');
            $('#theme-toggle-light-icon').classList.toggle('hidden', storedTheme === 'dark');

            const storedPrimaryColor = localStorage.getItem('primaryColor') || 'cyan';
            document.documentElement.setAttribute('data-theme', storedPrimaryColor);
            $$('[data-theme]').forEach(btn => btn.classList.toggle('ring-primary', btn.dataset.theme === storedPrimaryColor));

            $('#theme-toggle').addEventListener('click', () => {
                const isDarkMode = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                $('#theme-toggle-dark-icon').classList.toggle('hidden');
                $('#theme-toggle-light-icon').classList.toggle('hidden');
            });
            
            $$('[data-theme]').forEach(button => {
                button.addEventListener('click', function () {
                    const newTheme = this.dataset.theme;
                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('primaryColor', newTheme);
                    $$('[data-theme]').forEach(btn => btn.classList.remove('ring-primary'));
                    this.classList.add('ring-primary');
                });
            });

            $('#mobile-menu-toggle').addEventListener('click', () => {
                const sidebar = $('#sidebar');
                sidebar.classList.toggle('hidden');
                sidebar.classList.toggle('-translate-x-full');
            });
            $('#modal-close').addEventListener('click', closeModal);
            $('#modal-backdrop').addEventListener('click', closeModal);
            
            const navList = $('#navigation ul');
            navList.innerHTML = appData.map(page => {
                if(page.type === 'divider') return `<li class="px-3 pt-4 pb-2 text-xs font-semibold uppercase text-slate-400">${page.title}</li>`;
                return `<li><a href="#" class="nav-link flex items-center gap-4 p-3 rounded-lg hover:bg-slate-200/50 dark:hover:bg-slate-800/50 transition-colors" data-id="${page.id}">${page.icon} <span class="font-medium">${page.title}</span></a></li>`;
            }).join('');
            
            $$('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.dataset.id;
                    if (!pageId || state.currentPage === pageId) return;
                    
                    state.currentPage = pageId;
                    $$('.nav-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    const pageData = appData.find(p => p.id === pageId);
                    $('#page-title').textContent = pageData.title;
                    pageData.render();
                    
                    if (window.innerWidth < 768) {
                        const sidebar = $('#sidebar');
                        sidebar.classList.add('hidden');
                        sidebar.classList.add('-translate-x-full');
                    }
                });
            });

            // Inisialisasi Firebase dan muat halaman pertama
            await initAuth();
            $('.nav-link[data-id="dasbor"]').click();
        }

        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
